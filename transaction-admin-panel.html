<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transaction Admin Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    
    <style>
        /* Base Styles */
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f7fa;
            color: #333;
        }

        /* --- Sidebar Styles (Unchanged) --- */
        .sidebar {
            height: 100%;
            width: 0;
            position: fixed;
            z-index: 1001;
            top: 0;
            left: 0;
            background-color: #2c3e50;
            overflow-x: hidden;
            transition: 0.3s;
            padding-top: 60px;
            box-shadow: 2px 0 5px rgba(0,0,0,0.2);
        }

        .sidebar.open {
            width: 250px;
        }
        
        .sidebar-header {
            padding: 20px;
            color: #ecf0f1;
            font-size: 20px;
            font-weight: bold;
            text-align: center;
            border-bottom: 1px solid #34495e;
            position: absolute;
            top: 0;
            width: 100%;
            box-sizing: border-box;
        }

        .sidebar a {
            padding: 15px 25px;
            text-decoration: none;
            font-size: 16px;
            color: #ecf0f1;
            display: flex;
            align-items: center;
            transition: background-color 0.3s;
            border-radius: 5px;
            margin: 10px;
        }
        
        .sidebar a i {
            margin-right: 10px;
        }

        .sidebar a:hover {
            background-color: #1abc9c;
            color: white;
        }

        /* --- Header Styles (Unchanged) --- */
        header {
            background-color: #ffffff;
            color: #333;
            padding: 10px 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 999;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        #menuToggle {
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
            color: #2c3e50;
        }
        
        #menuToggleIcon {
            font-size: 24px;
        }

        /* Username Display */
        .username-display {
            font-size: 16px;
            font-weight: 500;
            color: #34495e;
            padding: 5px;
            border-radius: 4px;
            transition: color 0.3s;
            max-width: 100px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* Profile Dropdown Container (Combined with Notification) */
        .profile-actions {
            display: flex;
            align-items: center;
            gap: 15px; /* Added gap for separation */
        }

        .profile-dropdown, .notification-dropdown {
            position: relative;
            display: inline-block;
        }

        .profile-icon, .notification-icon {
            font-size: 24px; /* Reduced size slightly for better fit */
            cursor: pointer;
            color: #95a5a6;
            transition: color 0.3s;
            padding: 5px;
        }
        
        .notification-icon:hover, .profile-icon:hover {
            color: #1abc9c;
        }

        /* Notification Badge */
        .notification-badge {
            position: absolute;
            top: 0px;
            right: 0px;
            background-color: #e74c3c; /* Red color for unread count */
            color: white;
            border-radius: 50%;
            padding: 2px 6px;
            font-size: 10px;
            font-weight: bold;
            pointer-events: none; /* ‡¶Ø‡¶æ‡¶§‡ßá ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ú‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶á‡¶≠‡ßá‡¶®‡ßç‡¶ü ‡¶®‡¶∑‡ßç‡¶ü ‡¶®‡¶æ ‡¶π‡ßü */
            transform: translate(50%, -50%);
            display: none; /* JS ‡¶¶‡ßç‡¶¨‡¶æ‡¶∞‡¶æ ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã ‡¶π‡¶¨‡ßá */
        }
        
        /* Dropdown Menu Content (General) */
        .dropdown-content {
            display: none;
            position: absolute;
            background-color: #ffffff;
            min-width: 250px; 
            max-width: 350px;
            box-shadow: 0px 8px 16px 0px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            right: 0;
            top: 45px;
            border-radius: 5px;
            overflow: hidden;
            max-height: 400px;
            overflow-y: auto;
        }
        
        /* Notification Specific Styles */
        #notificationDropdownContent {
            right: auto; /* ‡¶¨‡¶æ‡¶Æ ‡¶¶‡¶ø‡¶ï‡ßá ‡¶∏‡¶∞‡ßá ‡¶Ü‡¶∏‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø */
            left: -250px; 
            min-width: 300px;
        }
        
        .dropdown-content a {
            color: #333;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            border-bottom: 1px solid #eee;
            transition: background-color 0.2s;
        }

        .dropdown-content a.logout-btn {
            color: #e74c3c;
            font-weight: bold;
        }
        
        .show {
            display: block;
        }
        
        /* Individual Notification Item */
        .notification-item {
            padding: 10px 15px;
            border-bottom: 1px solid #ecf0f1;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .notification-item:hover {
            background-color: #f4f7fa;
        }

        .notification-item.unread {
            background-color: #ecf0f1; /* Unread highlight */
            border-left: 3px solid #1abc9c;
            font-weight: 500;
        }

        .notification-title {
            font-size: 14px;
            color: #34495e;
            margin-bottom: 5px;
        }

        .notification-time {
            font-size: 11px;
            color: #7f8c8d;
        }

        .no-notifications {
            padding: 15px;
            text-align: center;
            color: #95a5a6;
            font-style: italic;
        }
        
        /* --- Main Content Area (Unchanged) --- */
        .dashboard-container {
            padding: 20px;
            max-width: 1200px;
            margin: 20px auto;
        }
        
        /* --- Login Required View (Unchanged) --- */
        #loginRequired {
            display: none; 
            text-align: center;
            padding: 50px;
            margin-top: 50px;
            background-color: #fff;
            border-radius: 10px;
            max-width: 500px;
            margin: 100px auto;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        
        /* --- Custom Admin Work Info Style (Unchanged) --- */
        .admin-work-info {
            background-color: #ecf0f1;
            border-left: 5px solid #1abc9c;
            padding: 20px;
            margin-top: 30px;
            border-radius: 5px;
            line-height: 1.6;
        }

        .admin-work-info h3 {
            color: #2c3e50;
            border-bottom: 2px solid #bdc3c7;
            padding-bottom: 10px;
            margin-top: 0;
        }

        .admin-work-info p {
            margin-bottom: 15px;
        }

        .admin-work-info strong {
            color: #e74c3c;
        }
        
        .loading-text {
            color: #95a5a6;
            font-style: italic;
        }
        
        @media (min-width: 768px) {
            /* ‡¶°‡ßá‡¶∏‡ßç‡¶ï‡¶ü‡¶™ ‡¶≠‡¶ø‡¶â‡¶§‡ßá ‡¶∏‡¶æ‡¶á‡¶°‡¶¨‡¶æ‡¶∞ ‡¶∏‡¶¨‡¶∏‡¶Æ‡ßü ‡¶ñ‡ßã‡¶≤‡¶æ ‡¶•‡¶æ‡¶ï‡¶¨‡ßá */
            .sidebar {
                width: 250px; 
            }
            .dashboard-container {
                margin-left: 270px;
            }
            header {
                padding-left: 270px; 
            }
            .header-left {
                gap: 5px;
            }
            #menuToggle {
                display: none; /* ‡¶°‡ßá‡¶∏‡ßç‡¶ï‡¶ü‡¶™‡ßá ‡¶ü‡¶ó‡¶≤ ‡¶¨‡ßã‡¶§‡¶æ‡¶Æ ‡¶≤‡ßÅ‡¶ï‡¶æ‡¶®‡ßã */
            }
            .username-display {
                 max-width: none;
            }
            .sidebar.open {
                width: 250px;
            }
        }

    </style>
</head>
<body>

    <div id="sidebar" class="sidebar">
        <div class="sidebar-header">Navigation</div>
        
        <a href="/home"><i class="fas fa-home"></i> Home</a>
        <a href="/data"><i class="fas fa-database"></i> Data Center</a>
        <a href="/help"><i class="fas fa-question-circle"></i> Help & Support</a>
    </div>

    <header>
        <div class="header-left">
            <button id="menuToggle" onclick="toggleSidebar()">
                <i class="fas fa-bars" id="menuToggleIcon"></i> 
            </button>
            
            <span id="usernameDisplay" class="username-display loading-text">Loading...</span>
        </div>
        
        <div class="profile-actions">
            <div class="notification-dropdown">
                <i class="fas fa-bell notification-icon" onclick="toggleNotificationDropdown(event)"></i>
                <span id="notificationBadge" class="notification-badge">0</span>
                
                <div id="notificationDropdownContent" class="dropdown-content">
                    <div class="no-notifications">No new notifications.</div>
                </div>
            </div>
            
            <div class="profile-dropdown">
                <i class="fas fa-user-circle profile-icon" onclick="toggleProfileDropdown(event)"></i>
                
                <div id="profileDropdownContent" class="dropdown-content">
                    <a href="profile.html"><i class="fas fa-user"></i> Profile</a>
                    <a href="#logout" class="logout-btn" onclick="signOutUser(event)"><i class="fas fa-sign-out-alt"></i> Logout</a>
                </div>
            </div>
        </div>
    </header>
    
    <div id="loginRequired" style="display:none;"> 
        <h2>Authentication Required</h2>
        <p>You are being redirected to the login page...</p>
    </div>

    <div id="dashboardContent" class="dashboard-container" style="display:none;">
        
        <h2>Welcome Transaction Management Admin</h2>
        
        <div class="admin-work-info">
            <h3>‡¶ó‡ßÅ‡¶∞‡ßÅ‡¶§‡ßç‡¶¨‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶ï‡¶æ‡¶ú‡ßá‡¶∞ ‡¶®‡¶ø‡¶∞‡ßç‡¶¶‡ßá‡¶∂‡¶ø‡¶ï‡¶æ (Important Work Guideline)</h3>
            
            <p><strong>‡¶∏‡¶Æ‡¶Ø‡¶º‡¶∏‡ßÄ‡¶Æ‡¶æ:</strong> ‡¶∏‡¶ï‡¶æ‡¶≤ ‡ßß‡ß¶:‡ß¶‡ß¶‡¶ü‡¶æ ‡¶π‡¶§‡ßá ‡¶∞‡¶æ‡¶§ ‡ß¶‡ßÆ:‡ß¶‡ß¶‡¶ü‡¶æ ‡¶™‡¶∞‡ßç‡¶Ø‡¶®‡ßç‡¶§‡•§</p>
            
            <p>‡¶è‡¶ï‡¶ú‡¶® ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶®‡ßá‡¶∞ ‡¶Æ‡ßÇ‡¶≤ ‡¶¶‡¶æ‡¶Ø‡¶º‡¶ø‡¶§‡ßç‡¶¨ ‡¶π‡¶≤‡ßã ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡¶ï‡¶æ‡¶∞‡ßÄ‡¶¶‡ßá‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶∏‡¶æ‡¶•‡ßá ‡¶§‡¶æ‡¶¶‡ßá‡¶∞ ‡¶∏‡¶Æ‡¶∏‡ßç‡¶§ ‡¶ï‡¶æ‡¶ú ‡¶ì ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ‡¶∞ ‡¶∏‡¶Æ‡¶æ‡¶ß‡¶æ‡¶® ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶ï‡¶∞‡¶æ‡•§ ‡¶ï‡¶∞‡ßç‡¶Æ‡¶¶‡¶ø‡¶¨‡¶∏‡ßá (‡¶∏‡¶ï‡¶æ‡¶≤ ‡ßß‡ß¶‡¶ü‡¶æ - ‡¶∞‡¶æ‡¶§ ‡ßÆ‡¶ü‡¶æ) ‡¶ï‡¶æ‡¶ú‡ßá‡¶∞ ‡¶ó‡ßÅ‡¶£‡¶ó‡¶§ ‡¶Æ‡¶æ‡¶® ‡¶¨‡¶ú‡¶æ‡¶Ø‡¶º ‡¶∞‡¶æ‡¶ñ‡¶§‡ßá ‡¶®‡¶ø‡¶Æ‡ßç‡¶®‡¶≤‡¶ø‡¶ñ‡¶ø‡¶§ ‡¶¨‡¶ø‡¶∑‡¶Ø‡¶º‡¶ó‡ßÅ‡¶≤‡ßã ‡¶Æ‡ßá‡¶®‡ßá ‡¶ö‡¶≤‡ßÅ‡¶®:</p>
            
            <ul>
                <li>**‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡¶ï‡¶æ‡¶∞‡ßÄ‡¶∞ ‡¶Ö‡¶ó‡ßç‡¶∞‡¶æ‡¶ß‡¶ø‡¶ï‡¶æ‡¶∞:** ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ü‡¶ø ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡¶ï‡¶æ‡¶∞‡ßÄ ‡¶Ö‡¶®‡ßÅ‡¶∞‡ßã‡¶ß‡¶ï‡ßá ‡¶∏‡¶∞‡ßç‡¶¨‡ßã‡¶ö‡ßç‡¶ö ‡¶Ö‡¶ó‡ßç‡¶∞‡¶æ‡¶ß‡¶ø‡¶ï‡¶æ‡¶∞ ‡¶¶‡¶ø‡¶® ‡¶è‡¶¨‡¶Ç ‡¶¶‡ßç‡¶∞‡ßÅ‡¶§‡¶§‡¶æ‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶∏‡¶Æ‡¶æ‡¶ß‡¶æ‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®‡•§</li>
                <li>**‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ ‡¶Æ‡¶®‡¶ø‡¶ü‡¶∞‡¶ø‡¶Ç:** ‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ‡ßá‡¶∞ ‡¶Æ‡¶∏‡ßÉ‡¶£ ‡¶ï‡¶æ‡¶∞‡ßç‡¶Ø‡¶ï‡¶æ‡¶∞‡¶ø‡¶§‡¶æ ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶ï‡¶∞‡¶§‡ßá ‡¶®‡¶ø‡¶Ø‡¶º‡¶Æ‡¶ø‡¶§ ‡¶™‡ßç‡¶≤‡ßç‡¶Ø‡¶æ‡¶ü‡¶´‡¶∞‡ßç‡¶Æ‡ßá‡¶∞ ‡¶∏‡ßç‡¶¨‡¶æ‡¶∏‡ßç‡¶•‡ßç‡¶Ø ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§</li>
                <li>**‡¶§‡¶•‡ßç‡¶Ø ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£:** ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ü‡¶ø ‡¶ó‡ßÅ‡¶∞‡ßÅ‡¶§‡ßç‡¶¨‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶® ‡¶¨‡¶æ ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ‡¶∞ ‡¶∏‡¶Æ‡¶æ‡¶ß‡¶æ‡¶®‡ßá‡¶∞ ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶∏‡ßÅ‡¶∏‡¶Ç‡¶ó‡¶†‡¶ø‡¶§‡¶≠‡¶æ‡¶¨‡ßá ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§</li>
                <li>**‡¶Ø‡ßã‡¶ó‡¶æ‡¶Ø‡ßã‡¶ó:** ‡¶ü‡¶ø‡¶Æ‡ßá‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶è‡¶¨‡¶Ç ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡¶ï‡¶æ‡¶∞‡ßÄ‡¶¶‡ßá‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶∏‡¶¨‡¶∏‡¶Æ‡¶Ø‡¶º ‡¶∏‡ßç‡¶™‡¶∑‡ßç‡¶ü, ‡¶¨‡¶ø‡¶®‡¶Ø‡¶º‡ßÄ ‡¶ì ‡¶™‡ßá‡¶∂‡¶æ‡¶¶‡¶æ‡¶∞‡ßÄ ‡¶≠‡¶æ‡¶∑‡¶æ‡¶Ø‡¶º ‡¶Ø‡ßã‡¶ó‡¶æ‡¶Ø‡ßã‡¶ó ‡¶¨‡¶ú‡¶æ‡¶Ø‡¶º ‡¶∞‡¶æ‡¶ñ‡ßÅ‡¶®‡•§</li>
            </ul>
            
            <p>Remember that your efficiency during the designated hours is crucial for user satisfaction and system stability.</p>
        </div>
        
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getDatabase, ref, get, set, onValue, update } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js"; // üî• Added 'onValue' and 'update'

        // IMPORTANT: Change this to your actual login page URL
        const LOGIN_PAGE_URL = "/login.html"; 

        // Firebase Config (Keep your actual config here)
        let firebaseConfig = {
            apiKey: "AIzaSyCS5HN0yT3e7el75fBc2HLcLmTnrcQZ7bc",
            authDomain: "exsurvey-1c78a.firebaseapp.com",
            databaseURL: "https://exsurvey-1c78a-default-rtdb.firebaseio.com",
            projectId: "exsurvey-1c78a",
            storageBucket: "exsurvey-1c78a.firebasestorage.app",
            messagingSenderId: "754959615386",
            appId: "1:754959615386:web:65c390db232a7dafd3e623",
            measurementId: "G-8SQNS2DLBT"
        };
        
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        let userId = null;
        // üî• New elements
        const usernameDisplay = document.getElementById('usernameDisplay');
        const dashboardContentDiv = document.getElementById('dashboardContent');
        const notificationBadge = document.getElementById('notificationBadge');
        const notificationDropdownContent = document.getElementById('notificationDropdownContent');
        const profileDropdownContent = document.getElementById('profileDropdownContent');


        // üî• ‡¶®‡¶§‡ßÅ‡¶® ‡¶®‡ßã‡¶ü‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶® ‡¶≤‡¶ø‡¶∏‡ßá‡¶®‡¶æ‡¶∞
        function setupNotificationListener(uid) {
            // üî• ‡¶®‡ßã‡¶° ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ: admin_notification/account/{UID}
            // ‡¶Ø‡ßá‡¶π‡ßá‡¶§‡ßÅ ‡¶Ü‡¶™‡¶®‡¶ø ‡¶¨‡¶≤‡ßá‡¶õ‡ßá‡¶® ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® 'Account Management' ‡¶è‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø, 
            // ‡¶§‡¶æ‡¶á ‡¶Ü‡¶™‡¶®‡¶æ‡¶ï‡ßá admin_notification/account/ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶®-ID ‡¶§‡ßá ‡¶®‡¶ú‡¶∞ ‡¶¶‡¶ø‡¶§‡ßá ‡¶π‡¶¨‡ßá‡•§
            
            // ‡¶ß‡¶∞‡ßá ‡¶®‡¶ø‡¶ö‡ßç‡¶õ‡¶ø ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶®‡ßá ‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡¶æ ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡ßá‡¶∞ (uid) ‡¶Ü‡¶á‡¶°‡¶ø-‡¶á ‡¶®‡ßã‡¶°‡ßá‡¶∞ ‡¶∂‡ßá‡¶∑ ‡¶Ö‡¶Ç‡¶∂‡•§
            // ‡¶Ø‡¶¶‡¶ø ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶Ü‡¶á‡¶°‡¶ø ‡¶´‡¶æ‡¶Ø‡¶º‡¶æ‡¶∞‡¶¨‡ßá‡¶∏ UID ‡¶•‡ßá‡¶ï‡ßá ‡¶≠‡¶ø‡¶®‡ßç‡¶® ‡¶π‡¶Ø‡¶º, ‡¶§‡¶¨‡ßá ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡¶§‡ßá ‡¶π‡¶¨‡ßá‡•§
            const notificationPath = `admin_notification/transaction/${uid}`;
            const notificationsRef = ref(db, notificationPath);
            
            onValue(notificationsRef, (snapshot) => {
                const notificationsData = snapshot.val();
                renderNotifications(notificationsData);
            });
        }
        
        // üî• ‡¶®‡ßã‡¶ü‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶® ‡¶∞‡ßá‡¶®‡ßç‡¶°‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®
        function renderNotifications(data) {
            notificationDropdownContent.innerHTML = '';
            let unreadCount = 0;
            
            if (!data) {
                notificationDropdownContent.innerHTML = `<div class="no-notifications">No notifications found.</div>`;
                notificationBadge.style.display = 'none';
                return;
            }

            // ‡¶®‡¶§‡ßÅ‡¶® ‡¶•‡ßá‡¶ï‡ßá ‡¶™‡ßÅ‡¶∞‡¶æ‡¶®‡ßã ‡¶ï‡ßç‡¶∞‡¶Æ‡ßá ‡¶∏‡¶æ‡¶ú‡¶æ‡¶®‡ßã
            const notificationKeys = Object.keys(data);
            const sortedNotifications = notificationKeys
                .map(key => ({ id: key, ...data[key] }))
                .sort((a, b) => b.timestamp - a.timestamp); // ‡¶®‡¶§‡ßÅ‡¶® timestamp ‡¶Ü‡¶ó‡ßá

            sortedNotifications.forEach(notification => {
                const itemDiv = document.createElement('div');
                itemDiv.classList.add('notification-item');
                
                // üî• Unread ‡¶π‡¶≤‡ßá ‡¶ï‡ßç‡¶≤‡¶æ‡¶∏ ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶ï‡¶∞‡¶æ
                if (!notification.read) {
                    itemDiv.classList.add('unread');
                    unreadCount++;
                }

                // üî• ‡¶®‡ßã‡¶ü‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶® ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡¶≤‡ßá read ‡¶π‡¶Ø‡¶º
                itemDiv.onclick = () => markAsRead(notification.id);
                
                // ‡¶∏‡¶Æ‡¶Ø‡¶º‡¶ï‡ßá ‡¶™‡¶†‡¶®‡¶Ø‡ßã‡¶ó‡ßç‡¶Ø ‡¶´‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ü‡ßá ‡¶∞‡ßÇ‡¶™‡¶æ‡¶®‡ßç‡¶§‡¶∞
                const date = new Date(notification.timestamp);
                const timeString = date.toLocaleString(); // ‡¶∏‡¶Æ‡¶Ø‡¶º ‡¶ì ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ
                
                itemDiv.innerHTML = `
                    <div class="notification-title">${notification.task_title || "New Task Submission"} (User: ${notification.user_name || "Unknown"})</div>
                    <div class="notification-time">${timeString}</div>
                `;
                
                notificationDropdownContent.appendChild(itemDiv);
            });
            
            // üî• ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ú ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ
            if (unreadCount > 0) {
                notificationBadge.textContent = unreadCount;
                notificationBadge.style.display = 'block';
            } else {
                notificationBadge.style.display = 'none';
                if (sortedNotifications.length === 0) {
                     notificationDropdownContent.innerHTML = `<div class="no-notifications">No new notifications.</div>`;
                }
            }
        }
        
        // üî• ‡¶®‡ßã‡¶ü‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶® 'read' ‡¶π‡¶ø‡¶∏‡ßá‡¶¨‡ßá ‡¶ö‡¶ø‡¶π‡ßç‡¶®‡¶ø‡¶§ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®
        async function markAsRead(notificationId) {
            if (!userId) return;
            
            const notificationPath = `admin_notification/transaction/${userId}/${notificationId}`;
            const notificationRef = ref(db, notificationPath);
            
            try {
                // 'read' property-‡¶ü‡¶ø true ‡¶ï‡¶∞‡¶æ
                await update(notificationRef, {
                    read: true
                });
                console.log(`Notification ${notificationId} marked as read.`);
                // ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶®‡ßã‡¶ü‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶® ‡¶°‡ßç‡¶∞‡¶™‡¶°‡¶æ‡¶â‡¶® ‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ï‡ßã‡¶®‡ßã ‡¶™‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶ú‡¶® ‡¶®‡ßá‡¶á, 
                // ‡¶ï‡¶æ‡¶∞‡¶£ Firebase ‡¶∞‡¶ø‡¶Ø‡¶º‡ßá‡¶≤-‡¶ü‡¶æ‡¶á‡¶Æ‡ßá ‡¶°‡ßá‡¶ü‡¶æ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶≤‡ßá‡¶á ‡¶∞‡ßá‡¶®‡ßç‡¶°‡¶æ‡¶∞Notifications ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ï‡¶≤ ‡¶π‡¶¨‡ßá‡•§
            } catch (error) {
                console.error("Error marking notification as read:", error);
            }
        }


        function handleAuthStatus(user) {
            if (user) {
                userId = user.uid;
                dashboardContentDiv.style.display = 'block';
                usernameDisplay.textContent = "Loading...";
                usernameDisplay.classList.add('loading-text');
                fetchUsername(userId);
                
                // üî• ‡¶®‡ßã‡¶ü‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶® ‡¶≤‡¶ø‡¶∏‡ßá‡¶®‡¶æ‡¶∞ ‡¶∏‡ßá‡¶ü‡¶Ü‡¶™ ‡¶ï‡¶∞‡¶æ
                setupNotificationListener(userId); 

                // ‡¶°‡ßá‡¶∏‡ßç‡¶ï‡¶ü‡¶™ ‡¶≠‡¶ø‡¶â‡¶§‡ßá ‡¶∏‡¶æ‡¶á‡¶°‡¶¨‡¶æ‡¶∞ ‡¶°‡¶ø‡¶´‡¶≤‡ßç‡¶ü‡¶≠‡¶æ‡¶¨‡ßá ‡¶ñ‡ßã‡¶≤‡¶æ ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶ï‡¶∞‡¶æ
                if (window.innerWidth >= 768) {
                    document.getElementById('sidebar').classList.add('open');
                }
            } else {
                // ... (‡¶≤‡¶ó‡¶á‡¶® ‡¶®‡¶æ ‡¶•‡¶æ‡¶ï‡¶≤‡ßá ‡¶™‡ßÇ‡¶∞‡ßç‡¶¨‡ßá‡¶∞ ‡¶≤‡¶ú‡¶ø‡¶ï)
                userId = null;
                dashboardContentDiv.style.display = 'none';
                usernameDisplay.textContent = "Not Logged In";
                usernameDisplay.classList.remove('loading-text');

                if (window.location.pathname !== LOGIN_PAGE_URL && window.location.pathname !== "/") {
                    console.log(`User not logged in. Redirecting to: ${LOGIN_PAGE_URL}`);
                    window.location.href = LOGIN_PAGE_URL;
                } else if (window.location.pathname === "/") {
                     console.log(`User not logged in. Redirecting to: ${LOGIN_PAGE_URL}`);
                     window.location.href = LOGIN_PAGE_URL;
                }
            }
        }
        
        /**
         * Fetches the username from Firebase Realtime Database. (Unchanged)
         */
        async function fetchUsername(uid) {
            if (!uid) return;
            
            const userRef = ref(db, `users/${uid}/username`);
            
            try {
                const snapshot = await get(userRef);
                
                if (snapshot.exists() && snapshot.val()) {
                    usernameDisplay.textContent = snapshot.val();
                } else {
                    console.warn(`Username not found at users/${uid}/username. Using UID snippet.`);
                    usernameDisplay.textContent = `User-${uid.substring(0, 8)}`;
                }
                usernameDisplay.classList.remove('loading-text');
            } catch (error) {
                console.error("RTDB Fetch Error:", error);
                usernameDisplay.textContent = "Data Error";
                usernameDisplay.classList.remove('loading-text');
            }
        }
        
        async function initializeAuth() {
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } 
            } catch (error) {
                console.error("Firebase Auth Error:", error);
                handleAuthStatus(null); 
            }
            onAuthStateChanged(auth, handleAuthStatus);
        }
        
        window.signOutUser = async function(event) {
            event.preventDefault(); 
            try {
                await signOut(auth);
                console.log("User signed out successfully.");
            } catch (error) {
                console.error("Sign Out Error:", error);
                alert("Sign Out Failed. Check console for details.");
            }
        }
        
        // üî• ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶°‡ßç‡¶∞‡¶™‡¶°‡¶æ‡¶â‡¶® ‡¶ü‡¶ó‡¶≤ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®
        window.toggleProfileDropdown = function(event) {
            event.stopPropagation(); // ‡¶Ø‡¶æ‡¶§‡ßá ‡¶â‡¶á‡¶®‡ßç‡¶°‡ßã ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶á‡¶≠‡ßá‡¶®‡ßç‡¶ü ‡¶¨‡¶®‡ßç‡¶ß ‡¶®‡¶æ ‡¶ï‡¶∞‡ßá
            profileDropdownContent.classList.toggle("show");
            // ‡¶Ö‡¶®‡ßç‡¶Ø ‡¶°‡ßç‡¶∞‡¶™‡¶°‡¶æ‡¶â‡¶®‡¶ü‡¶ø ‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡¶æ
            notificationDropdownContent.classList.remove("show"); 
        };
        
        // üî• ‡¶®‡ßã‡¶ü‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶® ‡¶°‡ßç‡¶∞‡¶™‡¶°‡¶æ‡¶â‡¶® ‡¶ü‡¶ó‡¶≤ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®
        window.toggleNotificationDropdown = function(event) {
            event.stopPropagation(); // ‡¶Ø‡¶æ‡¶§‡ßá ‡¶â‡¶á‡¶®‡ßç‡¶°‡ßã ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶á‡¶≠‡ßá‡¶®‡ßç‡¶ü ‡¶¨‡¶®‡ßç‡¶ß ‡¶®‡¶æ ‡¶ï‡¶∞‡ßá
            notificationDropdownContent.classList.toggle("show");
            // ‡¶Ö‡¶®‡ßç‡¶Ø ‡¶°‡ßç‡¶∞‡¶™‡¶°‡¶æ‡¶â‡¶®‡¶ü‡¶ø ‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡¶æ
            profileDropdownContent.classList.remove("show"); 
        };
        

        // üî• ‡¶Ü‡¶á‡¶ï‡¶® ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® (Unchanged)
        window.toggleSidebar = function() {
            const sidebar = document.getElementById('sidebar');
            const toggleIcon = document.getElementById('menuToggleIcon');
            sidebar.classList.toggle('open');
            
            if (sidebar.classList.contains('open')) {
                toggleIcon.classList.remove('fa-bars');
                toggleIcon.classList.add('fa-times'); 
            } else {
                toggleIcon.classList.remove('fa-times');
                toggleIcon.classList.add('fa-bars'); 
            }
        };

        // üî• ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶¨‡¶æ‡¶á‡¶∞‡ßá ‡¶π‡¶≤‡ßá ‡¶∏‡¶æ‡¶á‡¶°‡¶¨‡¶æ‡¶∞ ‡¶è‡¶¨‡¶Ç ‡¶°‡ßç‡¶∞‡¶™‡¶°‡¶æ‡¶â‡¶® ‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶≤‡¶ú‡¶ø‡¶ï
        window.onclick = function(event) {
            // 1. ‡¶°‡ßç‡¶∞‡¶™‡¶°‡¶æ‡¶â‡¶® ‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡¶æ
            if (!event.target.closest('.profile-dropdown') && !event.target.closest('.notification-dropdown')) {
                profileDropdownContent.classList.remove('show');
                notificationDropdownContent.classList.remove('show');
            }
            
            // 2. ‡¶õ‡ßã‡¶ü ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶®‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡¶≤‡ßá ‡¶∏‡¶æ‡¶á‡¶°‡¶¨‡¶æ‡¶∞ ‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡¶æ
            const sidebar = document.getElementById('sidebar');
            const toggleBtn = document.getElementById('menuToggle');
            
            if (window.innerWidth < 768 && sidebar.classList.contains('open')) {
                if (!sidebar.contains(event.target) && !toggleBtn.contains(event.target)) {
                    window.toggleSidebar();
                }
            }
        };
        
        window.onload = initializeAuth;
    </script>
</body>
</html>
