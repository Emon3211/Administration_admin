<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transaction Admin Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    
    <style>
        /* Base Styles */
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f7fa;
            color: #333;
        }

        /* --- Sidebar Styles (Unchanged) --- */
        .sidebar {
            height: 100%;
            width: 0;
            position: fixed;
            z-index: 1001;
            top: 0;
            left: 0;
            background-color: #2c3e50;
            overflow-x: hidden;
            transition: 0.3s;
            padding-top: 60px;
            box-shadow: 2px 0 5px rgba(0,0,0,0.2);
        }

        .sidebar.open {
            width: 250px;
        }
        
        .sidebar-header {
            padding: 20px;
            color: #ecf0f1;
            font-size: 20px;
            font-weight: bold;
            text-align: center;
            border-bottom: 1px solid #34495e;
            position: absolute;
            top: 0;
            width: 100%;
            box-sizing: border-box;
        }

        .sidebar a {
            padding: 15px 25px;
            text-decoration: none;
            font-size: 16px;
            color: #ecf0f1;
            display: flex;
            align-items: center;
            transition: background-color 0.3s;
            border-radius: 5px;
            margin: 10px;
        }
        
        .sidebar a i {
            margin-right: 10px;
        }

        .sidebar a:hover {
            background-color: #1abc9c;
            color: white;
        }

        /* --- Header Styles (Unchanged) --- */
        header {
            background-color: #ffffff;
            color: #333;
            padding: 10px 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 999;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        #menuToggle {
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
            color: #2c3e50;
        }
        
        #menuToggleIcon {
            font-size: 24px;
        }

        /* Username Display */
        .username-display {
            font-size: 16px;
            font-weight: 500;
            color: #34495e;
            padding: 5px;
            border-radius: 4px;
            transition: color 0.3s;
            max-width: 100px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* Profile Dropdown Container (Combined with Notification) */
        .profile-actions {
            display: flex;
            align-items: center;
            gap: 15px; /* Added gap for separation */
        }

        .profile-dropdown, .notification-dropdown {
            position: relative;
            display: inline-block;
        }

        .profile-icon, .notification-icon {
            font-size: 24px; /* Reduced size slightly for better fit */
            cursor: pointer;
            color: #95a5a6;
            transition: color 0.3s;
            padding: 5px;
        }
        
        .notification-icon:hover, .profile-icon:hover {
            color: #1abc9c;
        }

        /* Notification Badge */
        .notification-badge {
            position: absolute;
            top: 0px;
            right: 0px;
            background-color: #e74c3c; /* Red color for unread count */
            color: white;
            border-radius: 50%;
            padding: 2px 6px;
            font-size: 10px;
            font-weight: bold;
            pointer-events: none; /* যাতে ব্যাজের জন্য ক্লিক ইভেন্ট নষ্ট না হয় */
            transform: translate(50%, -50%);
            display: none; /* JS দ্বারা দেখানো হবে */
        }
        
        /* Dropdown Menu Content (General) */
        .dropdown-content {
            display: none;
            position: absolute;
            background-color: #ffffff;
            min-width: 250px; 
            max-width: 350px;
            box-shadow: 0px 8px 16px 0px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            right: 0;
            top: 45px;
            border-radius: 5px;
            overflow: hidden;
            max-height: 400px;
            overflow-y: auto;
        }
        
        /* Notification Specific Styles */
        #notificationDropdownContent {
            right: auto; /* বাম দিকে সরে আসার জন্য */
            left: -250px; 
            min-width: 300px;
        }
        
        .dropdown-content a {
            color: #333;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            border-bottom: 1px solid #eee;
            transition: background-color 0.2s;
        }

        .dropdown-content a.logout-btn {
            color: #e74c3c;
            font-weight: bold;
        }
        
        .show {
            display: block;
        }
        
        /* Individual Notification Item */
        .notification-item {
            padding: 10px 15px;
            border-bottom: 1px solid #ecf0f1;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .notification-item:hover {
            background-color: #f4f7fa;
        }

        .notification-item.unread {
            background-color: #ecf0f1; /* Unread highlight */
            border-left: 3px solid #1abc9c;
            font-weight: 500;
        }

        .notification-title {
            font-size: 14px;
            color: #34495e;
            margin-bottom: 5px;
        }

        .notification-time {
            font-size: 11px;
            color: #7f8c8d;
        }

        .no-notifications {
            padding: 15px;
            text-align: center;
            color: #95a5a6;
            font-style: italic;
        }
        
        /* --- Main Content Area (Unchanged) --- */
        .dashboard-container {
            padding: 20px;
            max-width: 1200px;
            margin: 20px auto;
        }
        
        /* --- Login Required View (Unchanged) --- */
        #loginRequired {
            display: none; 
            text-align: center;
            padding: 50px;
            margin-top: 50px;
            background-color: #fff;
            border-radius: 10px;
            max-width: 500px;
            margin: 100px auto;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        
        /* --- Custom Admin Work Info Style (Unchanged) --- */
        .admin-work-info {
            background-color: #ecf0f1;
            border-left: 5px solid #1abc9c;
            padding: 20px;
            margin-top: 30px;
            border-radius: 5px;
            line-height: 1.6;
        }

        .admin-work-info h3 {
            color: #2c3e50;
            border-bottom: 2px solid #bdc3c7;
            padding-bottom: 10px;
            margin-top: 0;
        }

        .admin-work-info p {
            margin-bottom: 15px;
        }

        .admin-work-info strong {
            color: #e74c3c;
        }
        
        .loading-text {
            color: #95a5a6;
            font-style: italic;
        }
        
        @media (min-width: 768px) {
            /* ডেস্কটপ ভিউতে সাইডবার সবসময় খোলা থাকবে */
            .sidebar {
                width: 250px; 
            }
            .dashboard-container {
                margin-left: 270px;
            }
            header {
                padding-left: 270px; 
            }
            .header-left {
                gap: 5px;
            }
            #menuToggle {
                display: none; /* ডেস্কটপে টগল বোতাম লুকানো */
            }
            .username-display {
                 max-width: none;
            }
            .sidebar.open {
                width: 250px;
            }
        }

    </style>
</head>
<body>

    <div id="sidebar" class="sidebar">
        <div class="sidebar-header">Navigation</div>
        
        <a href="/home"><i class="fas fa-home"></i> Home</a>
        <a href="/data"><i class="fas fa-database"></i> Data Center</a>
        <a href="/help"><i class="fas fa-question-circle"></i> Help & Support</a>
    </div>

    <header>
        <div class="header-left">
            <button id="menuToggle" onclick="toggleSidebar()">
                <i class="fas fa-bars" id="menuToggleIcon"></i> 
            </button>
            
            <span id="usernameDisplay" class="username-display loading-text">Loading...</span>
        </div>
        
        <div class="profile-actions">
            <div class="notification-dropdown">
                <i class="fas fa-bell notification-icon" onclick="toggleNotificationDropdown(event)"></i>
                <span id="notificationBadge" class="notification-badge">0</span>
                
                <div id="notificationDropdownContent" class="dropdown-content">
                    <div class="no-notifications">No new notifications.</div>
                </div>
            </div>
            
            <div class="profile-dropdown">
                <i class="fas fa-user-circle profile-icon" onclick="toggleProfileDropdown(event)"></i>
                
                <div id="profileDropdownContent" class="dropdown-content">
                    <a href="profile.html"><i class="fas fa-user"></i> Profile</a>
                    <a href="#logout" class="logout-btn" onclick="signOutUser(event)"><i class="fas fa-sign-out-alt"></i> Logout</a>
                </div>
            </div>
        </div>
    </header>
    
    <div id="loginRequired" style="display:none;"> 
        <h2>Authentication Required</h2>
        <p>You are being redirected to the login page...</p>
    </div>

    <div id="dashboardContent" class="dashboard-container" style="display:none;">
        
        <h2>Welcome Transaction Management Admin</h2>
        
        <div class="admin-work-info">
            <h3>গুরুত্বপূর্ণ কাজের নির্দেশিকা (Important Work Guideline)</h3>
            
            <p><strong>সময়সীমা:</strong> সকাল ১০:০০টা হতে রাত ০৮:০০টা পর্যন্ত।</p>
            
            <p>একজন অ্যাডমিনের মূল দায়িত্ব হলো ব্যবহারকারীদের সাথে সাথে তাদের সমস্ত কাজ ও সমস্যার সমাধান নিশ্চিত করা। কর্মদিবসে (সকাল ১০টা - রাত ৮টা) কাজের গুণগত মান বজায় রাখতে নিম্নলিখিত বিষয়গুলো মেনে চলুন:</p>
            
            <ul>
                <li>**ব্যবহারকারীর অগ্রাধিকার:** প্রতিটি ব্যবহারকারী অনুরোধকে সর্বোচ্চ অগ্রাধিকার দিন এবং দ্রুততার সাথে সমাধান করুন।</li>
                <li>**সিস্টেম মনিটরিং:** সিস্টেমের মসৃণ কার্যকারিতা নিশ্চিত করতে নিয়মিত প্ল্যাটফর্মের স্বাস্থ্য পরীক্ষা করুন।</li>
                <li>**তথ্য সংরক্ষণ:** প্রতিটি গুরুত্বপূর্ণ লেনদেন বা সমস্যার সমাধানের রেকর্ড সুসংগঠিতভাবে সংরক্ষণ করুন।</li>
                <li>**যোগাযোগ:** টিমের সাথে এবং ব্যবহারকারীদের সাথে সবসময় স্পষ্ট, বিনয়ী ও পেশাদারী ভাষায় যোগাযোগ বজায় রাখুন।</li>
            </ul>
            
            <p>Remember that your efficiency during the designated hours is crucial for user satisfaction and system stability.</p>
        </div>
        
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getDatabase, ref, get, set, onValue, update } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js"; // 🔥 Added 'onValue' and 'update'

        // IMPORTANT: Change this to your actual login page URL
        const LOGIN_PAGE_URL = "/login.html"; 

        // Firebase Config (Keep your actual config here)
        let firebaseConfig = {
            apiKey: "AIzaSyCS5HN0yT3e7el75fBc2HLcLmTnrcQZ7bc",
            authDomain: "exsurvey-1c78a.firebaseapp.com",
            databaseURL: "https://exsurvey-1c78a-default-rtdb.firebaseio.com",
            projectId: "exsurvey-1c78a",
            storageBucket: "exsurvey-1c78a.firebasestorage.app",
            messagingSenderId: "754959615386",
            appId: "1:754959615386:web:65c390db232a7dafd3e623",
            measurementId: "G-8SQNS2DLBT"
        };
        
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        let userId = null;
        // 🔥 New elements
        const usernameDisplay = document.getElementById('usernameDisplay');
        const dashboardContentDiv = document.getElementById('dashboardContent');
        const notificationBadge = document.getElementById('notificationBadge');
        const notificationDropdownContent = document.getElementById('notificationDropdownContent');
        const profileDropdownContent = document.getElementById('profileDropdownContent');


        // 🔥 নতুন নোটিফিকেশন লিসেনার
        function setupNotificationListener(uid) {
            // 🔥 নোড সেট করা: admin_notification/account/{UID}
            // যেহেতু আপনি বলেছেন আপনার অ্যাডমিন 'Account Management' এর জন্য, 
            // তাই আপনাকে admin_notification/account/ অ্যাডমিন-ID তে নজর দিতে হবে।
            
            // ধরে নিচ্ছি বর্তমানে লগইন করা ইউজারের (uid) আইডি-ই নোডের শেষ অংশ।
            // যদি আপনার অ্যাডমিন আইডি ফায়ারবেস UID থেকে ভিন্ন হয়, তবে এখানে পরিবর্তন করতে হবে।
            const notificationPath = `admin_notification/transaction/${uid}`;
            const notificationsRef = ref(db, notificationPath);
            
            onValue(notificationsRef, (snapshot) => {
                const notificationsData = snapshot.val();
                renderNotifications(notificationsData);
            });
        }
        
        // 🔥 নোটিফিকেশন রেন্ডার করার ফাংশন
        function renderNotifications(data) {
            notificationDropdownContent.innerHTML = '';
            let unreadCount = 0;
            
            if (!data) {
                notificationDropdownContent.innerHTML = `<div class="no-notifications">No notifications found.</div>`;
                notificationBadge.style.display = 'none';
                return;
            }

            // নতুন থেকে পুরানো ক্রমে সাজানো
            const notificationKeys = Object.keys(data);
            const sortedNotifications = notificationKeys
                .map(key => ({ id: key, ...data[key] }))
                .sort((a, b) => b.timestamp - a.timestamp); // নতুন timestamp আগে

            sortedNotifications.forEach(notification => {
                const itemDiv = document.createElement('div');
                itemDiv.classList.add('notification-item');
                
                // 🔥 Unread হলে ক্লাস যুক্ত করা
                if (!notification.read) {
                    itemDiv.classList.add('unread');
                    unreadCount++;
                }

                // 🔥 নোটিফিকেশন ক্লিক করলে read হয়
                itemDiv.onclick = () => markAsRead(notification.id);
                
                // সময়কে পঠনযোগ্য ফরম্যাটে রূপান্তর
                const date = new Date(notification.timestamp);
                const timeString = date.toLocaleString(); // সময় ও তারিখ
                
                itemDiv.innerHTML = `
                    <div class="notification-title">${notification.task_title || "New Task Submission"} (User: ${notification.user_name || "Unknown"})</div>
                    <div class="notification-time">${timeString}</div>
                `;
                
                notificationDropdownContent.appendChild(itemDiv);
            });
            
            // 🔥 ব্যাজ আপডেট করা
            if (unreadCount > 0) {
                notificationBadge.textContent = unreadCount;
                notificationBadge.style.display = 'block';
            } else {
                notificationBadge.style.display = 'none';
                if (sortedNotifications.length === 0) {
                     notificationDropdownContent.innerHTML = `<div class="no-notifications">No new notifications.</div>`;
                }
            }
        }
        
        // 🔥 নোটিফিকেশন 'read' হিসেবে চিহ্নিত করার ফাংশন
        async function markAsRead(notificationId) {
            if (!userId) return;
            
            const notificationPath = `admin_notification/transaction/${userId}/${notificationId}`;
            const notificationRef = ref(db, notificationPath);
            
            try {
                // 'read' property-টি true করা
                await update(notificationRef, {
                    read: true
                });
                console.log(`Notification ${notificationId} marked as read.`);
                // এখানে নোটিফিকেশন ড্রপডাউন বন্ধ করার কোনো প্রয়োজন নেই, 
                // কারণ Firebase রিয়েল-টাইমে ডেটা আপডেট করলেই রেন্ডারNotifications আবার কল হবে।
            } catch (error) {
                console.error("Error marking notification as read:", error);
            }
        }


        function handleAuthStatus(user) {
            if (user) {
                userId = user.uid;
                dashboardContentDiv.style.display = 'block';
                usernameDisplay.textContent = "Loading...";
                usernameDisplay.classList.add('loading-text');
                fetchUsername(userId);
                
                // 🔥 নোটিফিকেশন লিসেনার সেটআপ করা
                setupNotificationListener(userId); 

                // ডেস্কটপ ভিউতে সাইডবার ডিফল্টভাবে খোলা নিশ্চিত করা
                if (window.innerWidth >= 768) {
                    document.getElementById('sidebar').classList.add('open');
                }
            } else {
                // ... (লগইন না থাকলে পূর্বের লজিক)
                userId = null;
                dashboardContentDiv.style.display = 'none';
                usernameDisplay.textContent = "Not Logged In";
                usernameDisplay.classList.remove('loading-text');

                if (window.location.pathname !== LOGIN_PAGE_URL && window.location.pathname !== "/") {
                    console.log(`User not logged in. Redirecting to: ${LOGIN_PAGE_URL}`);
                    window.location.href = LOGIN_PAGE_URL;
                } else if (window.location.pathname === "/") {
                     console.log(`User not logged in. Redirecting to: ${LOGIN_PAGE_URL}`);
                     window.location.href = LOGIN_PAGE_URL;
                }
            }
        }
        
        /**
         * Fetches the username from Firebase Realtime Database. (Unchanged)
         */
        async function fetchUsername(uid) {
            if (!uid) return;
            
            const userRef = ref(db, `users/${uid}/username`);
            
            try {
                const snapshot = await get(userRef);
                
                if (snapshot.exists() && snapshot.val()) {
                    usernameDisplay.textContent = snapshot.val();
                } else {
                    console.warn(`Username not found at users/${uid}/username. Using UID snippet.`);
                    usernameDisplay.textContent = `User-${uid.substring(0, 8)}`;
                }
                usernameDisplay.classList.remove('loading-text');
            } catch (error) {
                console.error("RTDB Fetch Error:", error);
                usernameDisplay.textContent = "Data Error";
                usernameDisplay.classList.remove('loading-text');
            }
        }
        
        async function initializeAuth() {
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } 
            } catch (error) {
                console.error("Firebase Auth Error:", error);
                handleAuthStatus(null); 
            }
            onAuthStateChanged(auth, handleAuthStatus);
        }
        
        window.signOutUser = async function(event) {
            event.preventDefault(); 
            try {
                await signOut(auth);
                console.log("User signed out successfully.");
            } catch (error) {
                console.error("Sign Out Error:", error);
                alert("Sign Out Failed. Check console for details.");
            }
        }
        
        // 🔥 প্রোফাইল ড্রপডাউন টগল ফাংশন
        window.toggleProfileDropdown = function(event) {
            event.stopPropagation(); // যাতে উইন্ডো ক্লিক ইভেন্ট বন্ধ না করে
            profileDropdownContent.classList.toggle("show");
            // অন্য ড্রপডাউনটি বন্ধ করা
            notificationDropdownContent.classList.remove("show"); 
        };
        
        // 🔥 নোটিফিকেশন ড্রপডাউন টগল ফাংশন
        window.toggleNotificationDropdown = function(event) {
            event.stopPropagation(); // যাতে উইন্ডো ক্লিক ইভেন্ট বন্ধ না করে
            notificationDropdownContent.classList.toggle("show");
            // অন্য ড্রপডাউনটি বন্ধ করা
            profileDropdownContent.classList.remove("show"); 
        };
        

        // 🔥 আইকন পরিবর্তন নিশ্চিত করার ফাংশন (Unchanged)
        window.toggleSidebar = function() {
            const sidebar = document.getElementById('sidebar');
            const toggleIcon = document.getElementById('menuToggleIcon');
            sidebar.classList.toggle('open');
            
            if (sidebar.classList.contains('open')) {
                toggleIcon.classList.remove('fa-bars');
                toggleIcon.classList.add('fa-times'); 
            } else {
                toggleIcon.classList.remove('fa-times');
                toggleIcon.classList.add('fa-bars'); 
            }
        };

        // 🔥 ক্লিক বাইরে হলে সাইডবার এবং ড্রপডাউন বন্ধ করার লজিক
        window.onclick = function(event) {
            // 1. ড্রপডাউন বন্ধ করা
            if (!event.target.closest('.profile-dropdown') && !event.target.closest('.notification-dropdown')) {
                profileDropdownContent.classList.remove('show');
                notificationDropdownContent.classList.remove('show');
            }
            
            // 2. ছোট স্ক্রিনে ক্লিক করলে সাইডবার বন্ধ করা
            const sidebar = document.getElementById('sidebar');
            const toggleBtn = document.getElementById('menuToggle');
            
            if (window.innerWidth < 768 && sidebar.classList.contains('open')) {
                if (!sidebar.contains(event.target) && !toggleBtn.contains(event.target)) {
                    window.toggleSidebar();
                }
            }
        };
        
        window.onload = initializeAuth;
    </script>
</body>
</html>
